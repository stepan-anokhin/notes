# Весёлая теоремка

Ниже приводится доказательство Теоремы, которая обобщает следующую очевидную идею: 
пусть у нас имеется алгебраическая система c набором операций. 
Если некоторое свойство $P$ присуще всем элементам $A$, и алгебраические операции 
сохраняют данное свойство, то $P$ будет также присуще и всем элементам замыкания 
$A$ относительно операций. Это утверждение кажется очевидным. 

В случае, когда операторы - это функции с конечным числом аргументов данный вопрос 
решается тривиально. Пусть $A^\*$ это всевозможные значения, получающиеся в результате 
применения операций к элементам $A$ алгебраических операций конечное число раз. Легко 
показать, что $A^\*$ - и есть замыкание (минимально замкнутое множество, содержащее $A$).
Поскольку каждый $A^{\*}$ можно представить как результат применения алгебраических операций 
к элементам $A$, то выполнение $P$ на $A^\*$ доказывается как тривиальная индукция по наименьшему 
числу операций, необходимых для получения данного элемента.  

Ситуация усложняется, если мы разрешаем операторам иметь произвольное бесконечное число аргументов 
(счётное и более). В этом случае простая индукция не годится, поскольку количество операций, необходимых 
для получения данного элемента замыкания из исходных значений $A$ может также быть произвольно большим. 

Доказательство интересующего нас утверждения в наиболее общем случае (для операций с бесконечным числом 
аргументов) требует трансфинитной индукции, но во всём остальном следует идее, изложенной для случая 
операций с конечным числом аргументов. Для начала, правда, следует уточнить понятия "операции с бесконечным 
числом аргументов", "замыкания" и т.д.

# Случай с Конечным Числом Аргументов

<p align="center">
	<img src="./layers_algebraic.drawio.svg" width="400" alt="Layers">
</p>

## Определения

Сперва уточним, что мы понимаем под бесконечным набором аргументов. 

**Определение $O\_1$ (Полседовательности)**: Пусть задано некоторое множество $X$ и произвольное кардинальное число $\tau$. 
*Последовательностью* $\symbf{x} = x\_1, \thinspace x\_2, \thinspace \ldots, \thinspace x\_{\alpha}, \thinspace \ldots$ 
будем называть любую функцию $f:\tau \rightarrow X$. Сам кардинал $\tau$ мы будем называть *длиной* или *числом элементов* 
последовательности. Множество всех последовательностей одинаковой длины $\tau$ будем обозначать $X^{\tau}$. Ординальные 
числа $\alpha \in \tau$ будем называть *индексами* соответсвующих элементов последовательности. 

Теперь уточним, что такое операция от бесконечного числа аргументов. 

**Определение $O\_2$ (Операции)**: Пусть $\tau$ - произвольный кардинал. Тогда $\tau$-*арной* операцией 
над множеством $X$ будем называть любую функцию $f:X^{\tau} \rightarrow X$, которая отображает последовательности 
длины $\tau$ из элементов $X$ в $X$. Длину последовательностей $\tau$ мы будем называть *арностью* или 
*числом аргументов* соответствующей операции.  

Если в определенном контексте речь будет идти о разных операциях $f, g$, то для различения соответствующих 
арностей мы будем писать $\tau\_f, \tau\_g$. Если же сами операции индексированы 
$f\_1, \thinspace f\_2, \thinspace ..., \thinspace f\_i, \thinspace ...$, то для 
различения соответствующих арностей мы будем использовать те же индексы: 
$\tau\_1, \thinspace \tau\_2, \thinspace ..., \thinspace \tau\_i, \thinspace ...$ 

Введём ещё одно полезное соглашение. Если $f$ - $\tau$-арная операция над $X$ и $A \subseteq X$, то вместо 
$f(A^{\tau})$ мы также просто будем писать $f(A)$. Если же задано множество функций $F$, то объединение образов $A$
относительно всех операций $\bigcup\_{f \in F} f(A^{\tau\_f})$ мы будем коротко записывать как $F(A)$.

**Определение $O\_3$ (Замыкание)**: Будем говорить, что множество $A \subseteq X$ *замкнуто* относительное набора операций
$F$, определенных на $X$, если $F(A) \subseteq A$. *Замыканием* $[A]_F$ множества $A$ относительно набора операций $F$ 
будем называть наименьшее множество, содержащее $A$ и замкнутое относительно набора операций $F$. В случае, когда 
множество $F$ ясно из контекста, будем просто писать $[A]$

Из $O\_3$ непосредственно вытекает, что множество $A$ замкнуто тогда и только тогда, когда оно равно своему 
собственному замыканию $A = [A]$. Это в свою очередь немедленно влечёт, что для любого $A$ имеет место равенство 
$[[A]]=[A]$.  

Для удобства изложения нам также понадобится следующее полезное понятие:

**Определение $O\_4$ (Пополнение)**: *Пополнением* $\langle A \rangle\_F$ множества $A$ c помощью набора операций $F$ будем 
называть множество *новых* элементов, получаемых в результате однократного применения операций из $F$ к последовательностям
из $A$: $\langle A \rangle\_F = F(A) \setminus A$. В случае, когда множество $F$ ясно из контекста, будем просто писать 
$\langle A \rangle$.

Заметим, что из $O\_4$ следует, что множество $A$ замкнуто относительно набора операций $F$ тогда и только тогда, когда 
$\langle A \rangle\_F = \varnothing$

**Определение $O\_5$ (Свойство)**: *Свойством* элементов множества $X$ будем называть любую функцию 
$P:X\rightarrow \set{true, false\}$ принимающую на элементах $X$ значения из множества $\set{true, false\}$. 
*Областью истинности* $True(P)$ свойства $P$ будем называть набор элементов, на котором свойство $P$ возвращает значение 
$true$: $True(P) =  P^{-1}(\set{true\})$. Будем говорить, что набор операций $F$ *сохраняет свойство* 
$P$, если область истинности $True(P)$ замкнута относительно $F$: $True(P) = [True(P)]_F$. 

## Теорема

**Теорема**: Пусть имеется произвольное множество $X$, на котором заданы свойство $P$ и набор операций $F$, сохранящий 
$P$. Тогда для произвольного подмножества $G \subseteq X$, если $G \subseteq True(P)$, то и $[G]_F \subseteq True(P)$.

**Доказательство**:

Доказательство в общем случае следует тому же плану, что и в случае с конечным числом аргументов. Мы представим 
множество $[G]$ как набор "слоёв", каждый из которых получается как пополнение "слоёв", полученных на предыдущих шагах и
затем докажем искомое утверждение индукцией по номеру слоя. Единственное отличие заключается в том, что слоёв может быть 
более, чем счётно, и поэтому в качестве номеров слоёв мы вместо целых чисел будем использовать произвольные ординалы, а 
в место обычной инодукции - трансфинитную.

Для начала позаботимся о том, что мы выбрали достаточно большое множество индексов, позволяющее занумеровать все слои. 
Пусть $\Phi$ - это такой кардинал, что $\Phi>|X|$. Далее положим, по определению:

$$
\begin{equation}
G\_0 = G
\end{equation}
$$

Т.е. наш нулевой слой - это исходное множество $G$. Далее, предположим, что для всех $\alpha'<\alpha$ множества 
$G\_{\alpha'}$ уже построены. Обозначим как $G\_{<\alpha}^\*$ - объединение слоёв, полученных на предыдущих шагах:

$$
\begin{equation}
G\_{<\alpha}^\*=\bigcup\_{\alpha'<\alpha}G\_{\alpha'}
\end{equation}
$$

Тогда по определению слой с индексом $\alpha$ получается как пополнение всех предыдущих слоёв $G\_{<\alpha}^\*$:

$$
\begin{equation}
G\_{\alpha} = \langle G\_{<\alpha}^\* \rangle
\end{equation}
$$

И, наконец, обозначим объединение всех слоёв как $G^\*$: 

$$
\begin{equation}
G^\* = \bigcup\_{\alpha \in \Phi} G\_\alpha
\end{equation}
$$

Теперь наша промежуточная цель заключается в том, чтобы показать, что построенное таким образом множество $G^\*$ 
совпадает с искомым замыканием $[G]$. 

Для начала заметим, что $G\_\alpha \cap G\_\beta = \varnothing$ при $\alpha \not = \beta$. Действительно, предположим 
без потери общности, что $\alpha < \beta$, тогда $G\_\alpha \subseteq G\_{<\beta}^\*$, но, так как 
$G\_\beta = \langle G\_{<\beta}^\* \rangle$, $G\_\beta$ не содержит элементов $G\_{<\beta}^\*$ и, значит, элементов 
$G\_\alpha$.


Для этого нам понадобится среди прочего показать, что $G^\*$ замкнуто относительно операций $f\_i$. Трудность заключается в том, что число аргументов операций $f\_i$ может быть произвольно большим. Как убедиться в том, что построив все слои $G\_\alpha$ мы исчерпали все возможные значения, которые могут принимать $f\_i(x)$ на всевозможных последовательностях из элементов $G^\*$? Для этого-то мы и выбрали количество слоёв $\Phi$ настолько большим ($\Phi > |X|$). Это гарантирует нам, что на некотором шаге процесс добавления новых значений остановится и все последующие слои окажутся пустыми. Следующие 2 леммы доказывают это утверждение: 

**Лемма 1**: Существует такое $\xi \in \Phi$, что $G\_\xi = \varnothing$.

**Доказательство**: Предположим обратное, и $G\_\alpha \not = \varnothing$ для любого $\alpha \in \Phi$. Тогда пусть $h$ - это функция выбора, определенная на множестве слоёв $\{G\_0, G\_1, ..., G\_\alpha, ...\}, \alpha \in \Phi$. Поскольку слои попарно не пересекаются, то $h(G\_\alpha) \not = h(G\_\beta)$ при $\alpha \not = \beta$. Тогда сопоставляя каждому $\alpha \in \Phi$ значение $h(G\_\alpha)$ получим разно-значное отображение из $\Phi$ в $X$, что противоречит выбору $\Phi > |X|$. $\square$

**Лемма 2**: Если $G\_\alpha = \varnothing$, то $G\_{\alpha'} = \varnothing$ для всех $\alpha' > \alpha$.

**Доказательство**: Предположим обратное, и $\beta \in \Phi$ - это наименьший такой ординал, что $\beta > \alpha$ и $G\_{\beta} \not = \varnothing$. Поскольку $G\_{\alpha'} = \varnothing$ для всех промежуточных $\alpha < \alpha' < \beta$, то $G\_{<\beta}^\* = G\_{<\alpha}^\*$. Поскольку $G\_{\beta} \not = \varnothing$, то существует $x \in G\_{\beta}$, но тогда в силу определения (4) и равенства $G\_{<\beta}^\* = G\_{<\alpha}^\*$ выясняется, что $x \in  [G\_{<\beta}^\*] \setminus G\_{<\beta}^\*= [G\_{<\alpha}^\*] \setminus G\_{<\alpha}^\* = G\_\alpha$, откуда следует, что $G\_\alpha \not = \varnothing$. Полученное противоречие завершает докательство леммы. $\square$

Следующие 2 леммы завершают доказательство того, что $G^\*=[G]^\*$. 

**Лемма 3 (замкнутость)**: $G^\*$ замкнуто относительно операций $f\_i$.

**Доказательство**: Пусть $\xi \in \Phi$ - это наименьший такой ординал, что $G\_\xi = \varnothing$. $\xi$ существует в силу Леммы 1. Тогда в силу Леммы 2 получим $G^\*=G\_{<\xi}^\*$ (все более высокие слои пусты). Предположим, что для некоторой операции $f\_i$ и некоторой последовательности $x \in (G\_{<\xi}^\*)^{T\_i}$ значение $f\_i(x)$ лежит за пределами $G\_{<\xi}^\*$. Но тогда оно принадлежало бы $G\_{\xi}$, что противоречит выбору $\xi$. Полученное противоречие завершает докательство Леммы 3. $\square$

**Лемма 4 (минимальность)**: $G^\*$ - является наименьшим множеством замкнутым относительно операций $f\_i$.

**Доказательство**: Предположим, что $G^\*$ не является наименьшим множеством замкнутым относительно операций $f\_i$. Тогда найдётся такое $G'$, содержащее $G$ и замкнутое относительно операций $f\_i$, что $G^\* \not \subseteq G'$. Пусть $\alpha$ - это наименьший такой ординал, что слой $G\_\alpha$ содержит элемент $x$, отсутствующий в $G'$. Возможны 2 случая:
 1. Если $\alpha = 0$, тогда $x \in G$. Но из этого слоедует, что $G\not \subseteq G'$ - противоречие с выбором $G'$. 
 2. Если  $\alpha > 0$. Но тогда для некоторой операции $f\_i$ найдётся такая последовательность $z \in (G\_{<\alpha}^\*)^{T\_i}$, что $x=f\_i(z)$. Но в силу того, что $\alpha$ - наименьший такой ординал, получаем, что $z \in G'$, но тогда в силу замкнутости $G'$ получим, что $x \in G'$ - противоречие с выбором $x$. $\square$

Из Лемм 3-4 следует, что $G^\*=[G]^\*$. Таким образом, мы получили в своё распоряжение тот замечательный факт, что замыкание $[G]^\*$ распадается на непересекающиеся слои $G\_\alpha$, начиная с $G\_0=G$, и заканчивая $G\_\xi = \varnothing$, где каждый новый слой получается из предыдущих однократным применением операций $f\_i$. Следующая лемма завершает доказательсво Теоремы. 

**Лемма 5 (сохранение свойства)**: Свойство $P$ (из условия Теоремы) выполняется на всех элементах $[G]^\*$.

**Доказательство**: Предположим обратное. Пусть $\alpha$ - это наименьший такой ординал, что найдётся $x \in G\_\alpha$, для которого $P(x) = false$. Возможны 2 случая:
 1.  Если $\alpha = 0$, тогда $x \in G\_0 = G$, что противоречит тому, что $G\subseteq Tr(P)$ по условию Теоремы.
 2. Если  $\alpha > 0$, то для некоторой операции $f\_i$ найдётся такая последовательность $z \in (G\_{<\alpha}^\*)^{T\_i}$, что $x=f\_i(z)$. В силу минимальности $\alpha$ имеем $P(z\_j)=true$ для всех $j \in T\_i$. Но тогда $P(x)=true$ поскольку $f\_i$ сохраняют свойство $P$ по условию теоремы. Это противоречит выбору $x$. $\square$
