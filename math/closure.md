# Весёлая теоремка

Ниже приводится доказательство Теоремы, которая обобщает следующую очевидную идею: 
пусть у нас имеется алгебраическая система c набором операций. 
Если некоторое свойство $P$ присуще всем элементам $A$, и алгебраические операции 
сохраняют данное свойство, то $P$ будет также присуще и всем элементам замыкания 
$A$ относительно операций. Это утверждение кажется очевидным. 

В случае, когда операторы - это функции с конечным числом аргументов данный вопрос 
решается тривиально. Пусть $A^\*$ это всевозможные значения, получающиеся в результате 
применения операций к элементам $A$ алгебраических операций конечное число раз. Легко 
показать, что $A^\*$ - и есть замыкание (минимально замкнутое множество, содержащее $A$).
Поскольку каждый $A^{\*}$ можно представить как результат применения алгебраических операций 
к элементам $A$, то выполнение $P$ на $A^\*$ доказывается как тривиальная индукция по наименьшему 
числу операций, необходимых для получения данного элемента.  

Ситуация усложняется, если мы разрешаем операторам иметь произвольное бесконечное число аргументов 
(счётное и более). В этом случае простая индукция не годится, поскольку количество операций, необходимых 
для получения данного элемента замыкания из исходных значений $A$ может также быть произвольно большим. 

Доказательство интересующего нас утверждения в наиболее общем случае (для операций с бесконечным числом 
аргументов) требует трансфинитной индукции, но во всём остальном следует идее, изложенной для случая 
операций с конечным числом аргументов. Для начала, правда, следует уточнить понятия "операции с бесконечным 
числом аргументов", "замыкания" и т.д.

# Случай с Конечным Числом Аргументов

<p align="center">
	<img src="./layers_algebraic.drawio.svg" width="400" alt="Layers">
</p>

## Определения

Сперва уточним, что мы понимаем под бесконечным набором аргументов. 

**Определение 1 (Полседовательность)**: Пусть задано некоторое множество $X$ и произвольное кардинальное число $\tau$. 
*Последовательностью* $x = \{ x\_1, x\_2, ..., x\_{\alpha}, ... \}$ будем называть любую функцию $f:\tau \rightarrow X$. 
Множество всех таких последовательностей одинаковой длины $\tau$ будем обозначать $X^{\tau}$. 
Ординальные числа $\alpha \in \tau$ будем называть *индексами* соответсвующих элементов последовательности. 

Теперь определим, что такое операция от бесконечного числа аргументов. 

**Определение 2 (Операции)**: Пусть $\tau$ - некоторый кардинал. Тогда $\tau$-*арной* операцией 
над множеством $X$ будем называть любую функцию $f:X^{\tau} \rightarrow X$, которая отображает последовательности 
из $X^{\tau}$ в $X$. Количество аргументов $\tau$ будем называть *арностью* операции. 

Если в определенном контексте контексте речь будет идти о разных функциях $f, g$, то для обозначения соответствующих 
арностей мы будем писать $\tau\_f, \tau\_g$. Если функции индексированы $f\_1, f\_2, ..., f\_i, ...$, то для 
различения соответствующих арностей мы будем использовать те же индексы: $\tau\_1, \tau\_2, ..., \tau\_i, ...$. 

**Определение 3 (Замыкание)**: Пусть на множестве $X$ задана операция $f:X^\tau\rightarrow X$. 
Будем говорить, что подмножество $A\subseteq X$ *замкнуто относительно* $f$, если для любого 
набора аргументов $x$ из $A^T$ результат применения операции $f(x)$ будет также содержаться в 
$A$, т.е. $f(A^T) \subseteq A$. Образ множества $A$ относительно множества операций $F$ будем 
обозначать как $F(A)$. Т.е. $F(A) = \bigcup_{f \in F} f(A^{T_f})$. Будем говорить, что множество 
$A$ *замкнуто относительно набора оперций* $F$, если $A$ замкнуто относительно каждой операции 
$f \in F$, а именно $F(A) \subseteq A$. *Замыканием* множества $A\subseteq X$ относительно 
операций $F$ будем называть наименьшее множество $[A]\_F \subseteq X$ замкнутое относительно 
$F$ и содержащее $A$. Множество $[A]_F$ - наименьшее в том с мысле, что оно содержится в любом 
замкнутом относительно $F$ множестве, содержащем $A$:  
$\forall B \subseteq X: A \subseteq B \land \forall f \in F $ и 
$B$ замкнуто относительно $f\_1, ...., f\_n$, то $[A]\_{f\_1,...,fn}^{\*} \subseteq B$. 
В случае, когда набор функций $f\_1,...,f\_n$ ясен из контекста, будем просто писать $[A]^{\*}$

**Определение 3.4**: *Пополнением* множества $A$ c помощью набора операций $F$ будем называть множество 
$\langle A \rangle\_F \subseteq X$, содержащее новые, не входящие в $A$, значения, получаемые  в результате 
однократного применения операций $F$. Более точно: $\langle A \rangle\_F = F(A) \setminus A$. Если набор 
операций $F$ ясен из контекста, будем просто писать $\langle A \rangle$.

**Определение 4.1**: *Свойством* элементов множества $X$ будет называть любую функцию 
$P:X\rightarrow \{true, false\}$ принимающую на элементах $X$ значения из $\{true, false\}$. 

**Определение 4.2**: *Областью истинности* $Tr(P)\subseteq X$ будем называть множество элементов 
$X$ на которых $P$ принимает значение $true$, а именно $Tr(P) = P^{-1}(\{true\})$. 

**Определение 5**: Будем говорить, что набор операций $f\_i:X^{T\_i}\rightarrow X$ *сохраняет свойство* 
$P$, если область истинности $Tr(P)$ замкнута относительно $f\_i$.

## Теорема

**Теорема**: Пусть задано произвольное множество $X$ с конечным набором операций $f\_1,f\_2,...f\_n$ 
произвольной арности. Пусть $G\subset X$ - некоторое подмножество $X$ на котором выполняется свойство 
$P$. Если $f\_i$ сохраняют свойство $P$, то это свойство выполняется на всех элементах замыкания 
$[G]^{\*}$ относительно операций $f\_i$.

**Доказательство**:
Пусть $\Phi$ - это такой кардинал, что $\Phi>|X|$. Мы хотим "расслоить" $[G]^\*$ на набор попарно 
непересекающихся множеств $G\_{\alpha}$, где индексы $\alpha$ - это ординальные числа из $\Phi$: 

$$
\begin{equation}
[G]^\*=\bigcup\_{\alpha \in \Phi}G\_{\alpha}
\end{equation}
$$

Наша цель - сделать это таким образом, чтобы элементы каждого "слоя" $G\_\alpha$ получались в 
результате однократного применения операций $f\_i$ к элементам из "нижних" слоёв. 

Положим, по определению:

$$
\begin{equation}
G\_0 = G
\end{equation}
$$

Далее, предположим, что для всех $\alpha'<\alpha$ множества $G\_{\alpha'}$ уже построены. 
Тогда положим по определению:

$$
\begin{equation}
G\_{<\alpha}^\*=\bigcup\_{\alpha'<\alpha}G\_{\alpha'}
\end{equation}
$$

$$
\begin{equation}
G\_{\alpha} = [G\_{<\alpha}^\*] \setminus G\_{<\alpha}^\*
\end{equation}
$$

$$
\begin{equation}
G\_{\alpha}^\* = G\_{<\alpha}^\* \cup G\_\alpha
\end{equation}
$$

И наконец обозначим объединение всех слоёв: 

$$
\begin{equation}
G^\* = \bigcup\_{\alpha \in \Phi} G\_\alpha
\end{equation}
$$

Теперь наша промежуточная цель состоит в том, чтобы показать, что определенная таким образом $G^\*$ совпадает с искомым замыканием $[G]^\*$. Для этого нам понадобится среди прочего показать, что $G^\*$ замкнуто относительно операций $f\_i$. Трудность заключается в том, что число аргументов операций $f\_i$ может быть произвольно большим. Как убедиться в том, что построив все слои $G\_\alpha$ мы исчерпали все возможные значения, которые могут принимать $f\_i(x)$ на всевозможных последовательностях из элементов $G^\*$? Для этого-то мы и выбрали количество слоёв $\Phi$ настолько большим ($\Phi > |X|$). Это гарантирует нам, что на некотором шаге процесс добавления новых значений остановится и все последующие слои окажутся пустыми. Следующие 2 леммы доказывают это утверждение: 

**Лемма 1**: Существует такое $\xi \in \Phi$, что $G\_\xi = \varnothing$.

**Доказательство**: Предположим обратное, и $G\_\alpha \not = \varnothing$ для любого $\alpha \in \Phi$. Тогда пусть $h$ - это функция выбора, определенная на множестве слоёв $\{G\_0, G\_1, ..., G\_\alpha, ...\}, \alpha \in \Phi$. Поскольку слои попарно не пересекаются, то $h(G\_\alpha) \not = h(G\_\beta)$ при $\alpha \not = \beta$. Тогда сопоставляя каждому $\alpha \in \Phi$ значение $h(G\_\alpha)$ получим разно-значное отображение из $\Phi$ в $X$, что противоречит выбору $\Phi > |X|$. $\square$

**Лемма 2**: Если $G\_\alpha = \varnothing$, то $G\_{\alpha'} = \varnothing$ для всех $\alpha' > \alpha$.

**Доказательство**: Предположим обратное, и $\beta \in \Phi$ - это наименьший такой ординал, что $\beta > \alpha$ и $G\_{\beta} \not = \varnothing$. Поскольку $G\_{\alpha'} = \varnothing$ для всех промежуточных $\alpha < \alpha' < \beta$, то $G\_{<\beta}^\* = G\_{<\alpha}^\*$. Поскольку $G\_{\beta} \not = \varnothing$, то существует $x \in G\_{\beta}$, но тогда в силу определения (4) и равенства $G\_{<\beta}^\* = G\_{<\alpha}^\*$ выясняется, что $x \in  [G\_{<\beta}^\*] \setminus G\_{<\beta}^\*= [G\_{<\alpha}^\*] \setminus G\_{<\alpha}^\* = G\_\alpha$, откуда следует, что $G\_\alpha \not = \varnothing$. Полученное противоречие завершает докательство леммы. $\square$

Следующие 2 леммы завершают доказательство того, что $G^\*=[G]^\*$. 

**Лемма 3 (замкнутость)**: $G^\*$ замкнуто относительно операций $f\_i$.

**Доказательство**: Пусть $\xi \in \Phi$ - это наименьший такой ординал, что $G\_\xi = \varnothing$. $\xi$ существует в силу Леммы 1. Тогда в силу Леммы 2 получим $G^\*=G\_{<\xi}^\*$ (все более высокие слои пусты). Предположим, что для некоторой операции $f\_i$ и некоторой последовательности $x \in (G\_{<\xi}^\*)^{T\_i}$ значение $f\_i(x)$ лежит за пределами $G\_{<\xi}^\*$. Но тогда оно принадлежало бы $G\_{\xi}$, что противоречит выбору $\xi$. Полученное противоречие завершает докательство Леммы 3. $\square$

**Лемма 4 (минимальность)**: $G^\*$ - является наименьшим множеством замкнутым относительно операций $f\_i$.

**Доказательство**: Предположим, что $G^\*$ не является наименьшим множеством замкнутым относительно операций $f\_i$. Тогда найдётся такое $G'$, содержащее $G$ и замкнутое относительно операций $f\_i$, что $G^\* \not \subseteq G'$. Пусть $\alpha$ - это наименьший такой ординал, что слой $G\_\alpha$ содержит элемент $x$, отсутствующий в $G'$. Возможны 2 случая:
 1. Если $\alpha = 0$, тогда $x \in G$. Но из этого слоедует, что $G\not \subseteq G'$ - противоречие с выбором $G'$. 
 2. Если  $\alpha > 0$. Но тогда для некоторой операции $f\_i$ найдётся такая последовательность $z \in (G\_{<\alpha}^\*)^{T\_i}$, что $x=f\_i(z)$. Но в силу того, что $\alpha$ - наименьший такой ординал, получаем, что $z \in G'$, но тогда в силу замкнутости $G'$ получим, что $x \in G'$ - противоречие с выбором $x$. $\square$

Из Лемм 3-4 следует, что $G^\*=[G]^\*$. Таким образом, мы получили в своё распоряжение тот замечательный факт, что замыкание $[G]^\*$ распадается на непересекающиеся слои $G\_\alpha$, начиная с $G\_0=G$, и заканчивая $G\_\xi = \varnothing$, где каждый новый слой получается из предыдущих однократным применением операций $f\_i$. Следующая лемма завершает доказательсво Теоремы. 

**Лемма 5 (сохранение свойства)**: Свойство $P$ (из условия Теоремы) выполняется на всех элементах $[G]^\*$.

**Доказательство**: Предположим обратное. Пусть $\alpha$ - это наименьший такой ординал, что найдётся $x \in G\_\alpha$, для которого $P(x) = false$. Возможны 2 случая:
 1.  Если $\alpha = 0$, тогда $x \in G\_0 = G$, что противоречит тому, что $G\subseteq Tr(P)$ по условию Теоремы.
 2. Если  $\alpha > 0$, то для некоторой операции $f\_i$ найдётся такая последовательность $z \in (G\_{<\alpha}^\*)^{T\_i}$, что $x=f\_i(z)$. В силу минимальности $\alpha$ имеем $P(z\_j)=true$ для всех $j \in T\_i$. Но тогда $P(x)=true$ поскольку $f\_i$ сохраняют свойство $P$ по условию теоремы. Это противоречит выбору $x$. $\square$
